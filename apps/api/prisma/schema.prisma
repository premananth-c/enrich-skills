generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id             String   @id @default(uuid())
  name           String
  slug           String   @unique
  planId         String?
  domain         String?  @unique
  status         String   @default("active") // active, suspended, trial, cancelled
  brandingConfig Json     @default("{}")
  featureFlags   Json     @default("{}")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  users    User[]
  tests    Test[]
  courses  Course[]
  questions Question[]
  invites   Invite[]
}

model Invite {
  id        String    @id @default(uuid())
  tenantId  String
  email     String
  token     String    @unique
  expiresAt DateTime
  invitedBy String
  testId    String?   // optional: when used, student is allocated to this test
  variantId String?
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  inviter User    @relation("InvitedBy", fields: [invitedBy], references: [id], onDelete: Cascade)
  test    Test?   @relation(fields: [testId], references: [id], onDelete: SetNull)
  variant TestVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@index([token])
  @@index([tenantId, email])
}

model User {
  id           String   @id @default(uuid())
  tenantId     String
  email        String
  passwordHash String
  name         String
  phoneNumber  String?  // student profile
  address      String?  // student profile
  role         String   @default("student") // student, admin, proctor, content_author, platform_operator
  cohortIds    String[] @default([])
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  attempts Attempt[]
  invitesSent Invite[] @relation("InvitedBy")

  @@unique([tenantId, email])
  @@index([tenantId])
}

model Test {
  id         String   @id @default(uuid())
  tenantId   String
  title      String
  type       String   // coding, mcq
  status     String   @default("draft") // draft, published, archived
  difficulty String?  // easy, medium, hard (optional overall difficulty label)
  config     Json
  schedule   Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  testQuestions   TestQuestion[]
  attempts        Attempt[]
  assignmentTests AssignmentTest[]
  variants        TestVariant[]
  allocations     TestAllocation[]
  invites         Invite[]
}

model Question {
  id        String   @id @default(uuid())
  tenantId  String
  type      String   // coding, mcq
  content   Json
  difficulty String  // easy, medium, hard
  tags      String[] @default([])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  testCases    TestCase[]
  testQuestions TestQuestion[]
  submissions  Submission[]
}

model TestCase {
  id            String   @id @default(uuid())
  questionId    String
  input         String
  expectedOutput String
  isPublic      Boolean  @default(false)
  weight        Int      @default(1)
  createdAt     DateTime @default(now())

  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
}

model TestQuestion {
  id         String  @id @default(uuid())
  testId     String
  questionId String
  order      Int     @default(0)
  variantId  String? // if null, belongs to default set; otherwise to a specific TestVariant

  test     Test         @relation(fields: [testId], references: [id], onDelete: Cascade)
  question Question     @relation(fields: [questionId], references: [id], onDelete: Cascade)
  variant  TestVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@unique([testId, questionId])
  @@index([testId])
  @@index([variantId])
}

model TestVariant {
  id         String @id @default(uuid())
  testId     String
  name       String // e.g. "Easy Set", "Medium Set"
  difficulty String // easy, medium, hard
  createdAt  DateTime @default(now())

  test          Test             @relation(fields: [testId], references: [id], onDelete: Cascade)
  testQuestions TestQuestion[]
  allocations   TestAllocation[]
  attempts      Attempt[]
  invites       Invite[]

  @@index([testId])
}

model TestAllocation {
  id         String   @id @default(uuid())
  userId     String
  testId     String
  variantId  String?
  assignedBy String?  // admin user id who assigned
  assignedAt DateTime @default(now())

  test    Test         @relation(fields: [testId], references: [id], onDelete: Cascade)
  variant TestVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@unique([userId, testId])
  @@index([testId])
}

model Attempt {
  id          String    @id @default(uuid())
  userId      String
  testId      String
  variantId   String?   // if the test has variants, which variant this attempt uses
  startedAt   DateTime  @default(now())
  submittedAt DateTime?
  score       Float?
  maxScore    Float?
  status      String    @default("in_progress") // in_progress, submitted, graded

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  test        Test         @relation(fields: [testId], references: [id], onDelete: Cascade)
  variant     TestVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  submissions Submission[]
}

model Submission {
  id              String   @id @default(uuid())
  attemptId       String
  questionId      String
  code            String?
  language        String?
  selectedOptionId String?
  status          String   @default("pending") // pending, running, passed, failed, error
  score           Float?
  aiRatings       Json?
  output          String?
  errorMessage    String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  attempt  Attempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([attemptId, questionId])
  @@index([attemptId])
}

model Course {
  id          String   @id @default(uuid())
  tenantId    String
  title       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assignments Assignment[]
}

model Assignment {
  id          String    @id @default(uuid())
  courseId    String
  title       String
  description String?
  dueDate     DateTime?
  gradingType String    @default("auto") // auto, manual, hybrid
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  assignmentTests AssignmentTest[]
}

model AssignmentTest {
  id           String @id @default(uuid())
  assignmentId String
  testId       String

  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  test       Test       @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@unique([assignmentId, testId])
}

